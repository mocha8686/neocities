---
import { Font } from 'astro:assets';

import BaseLayout from '$src/layouts/BaseLayout.astro';
---

<BaseLayout>
	<Fragment slot="head">
		<Font cssVariable="--font-rodin" preload />
	</Fragment>

	<button
		class="text"
		x-data
		x-show="$store.text.show"
		x-transition.opacity.duration.500ms
		x-on:click="$store.text.advance()"
		style="display: none;"
	>
		<h1 x-bind:data-text="$store.text.speaker" x-text="$store.text.speaker">
		</h1>
		<div class="body">
			<template x-for="line in $store.text.lines">
				<p x-bind:data-text="line" x-text="line"></p>
			</template>
		</div>
		<svg>
			<filter id="shadow">
				<feMorphology
					in="SourceGraphic"
					operator="dilate"
					radius="2.5"
					result="shape"></feMorphology>
				<feFlood flood-color="#444566" flood-opacity="0.75" result="color"
				></feFlood>
				<feComposite in="color" in2="shape" operator="in" result="outline"
				></feComposite>

				<feMerge>
					<feMergeNode in="outline"></feMergeNode>
					<feMergeNode in="SourceGraphic"></feMergeNode>
				</feMerge>
			</filter>
		</svg>
	</button>

	<script>
		import Alpine from 'alpinejs';

		import alleyway from '$src/assets/alleyway/alleyway.png';
		import ena from '$src/assets/alleyway/ena.png';
		import ena_closeup from '$src/assets/alleyway/ena_closeup.png';
		import mizuki from '$src/assets/alleyway/mizuki.png';
		// @ts-expect-error ignore yaml import
		import script from '$src/lib/alleyway.yaml';

		type Node = string | Partial<Settings>;
		interface Settings {
			bg: 'white' | 'black' | 'alleyway' | 'ena' | 'ena_closeup' | 'mizuki';
			speaker: string;
		}

		const bgs = {
			mizuki: mizuki.src,
		};

		Alpine.store('text', {
			show: false,
			speaker: '',
			body: '',
			i: 0,

			advance() {
				const node: Node | undefined = script[this.i++];
				console.log(node);
				if (!node) return;

				if (typeof node === 'string') {
					this.show = true;
					this.body = node;
				} else {
					if (node.speaker) {
						this.speaker = node.speaker;
					}

					if (node.bg) {
						let bg = node.bg;
						if (node.bg !== 'white' && node.bg !== 'black') {
							bg = `url('/src/assets/alleyway/${node.bg}.png')`;
						}
						document.body.style.setProperty('--bg', bg);
					}

					this.advance();
				}
			},

			get lines() {
				// @ts-expect-error tsc doesn't know what this is
				return this.body.split('\n');
			},
		});

		document.addEventListener('alpine:init', () =>
			setTimeout(() => {
				Alpine.store('text').advance();
			}, 2000),
		);
	</script>
</BaseLayout>

<style is:global>
	:root {
		--cl-light: #fff;
		--cl-dark: #444566;
		--cl-accent: oklch(60% 0.11 337);

		--ff-main: var(--font-rodin);
		--fs-main: 1.5rem;

		--fw-body: 600;
		--fw-heading: 700;
	}

	body {
		--bg: url('/src/assets/alleyway/alleyway.png');

		accent-color: var(--cl-accent);
		display: grid;
		grid-template:
			'clear' 1fr
			'text' calc(6em + 4rem) / auto;

		height: 100vh;

		font-family: var(--ff-main);
		font-size: var(--fs-main);
		color: var(--cl-light);

		background:
			center/cover var(--bg) no-repeat,
			var(--cl-dark);
	}

	.text {
		--text-margin: 1fr;
		--text-area-size: 6fr;

		--alpha: 0.25;
		--stop: 50%;

		display: grid;
		grid-area: text;
		grid-template-columns:
			var(--text-margin)
			[content-start] var(--text-area-size) [content-end] var(--text-margin);
		grid-template-rows: auto 1fr;
		row-gap: 0.25rem;

		padding-block-start: 1.5rem;
		border: none;

		font: inherit;
		color: inherit;
		text-align: left;

		background: linear-gradient(
			to top,
			rgb(0 0 0 / var(--alpha)) var(--stop),
			transparent
		);

		> * {
			grid-column: content;
		}

		h1 {
			position: relative;

			margin: 0;

			font-size: var(--fs-main);
			font-weight: var(--fw-heading);
			letter-spacing: 1px;

			&::after {
				--alpha: 0.5;
				--stop: 60%;

				content: '';

				position: absolute;
				z-index: -500;
				inset-block-end: 0.25ex;
				inset-inline: -0.5em 0;

				height: 0.65ex;
				border-radius: 1rem;

				opacity: var(--alpha);
				background: linear-gradient(
					to right,
					var(--cl-light),
					transparent var(--stop)
				);
			}
		}

		p {
			margin: 0;
			margin-inline-start: 0.5em;
			font-size: var(--fs-main);
			font-weight: var(--fw-body);

			+ p {
				margin-block-start: -0.2em;
			}
		}

		h1,
		p {
			&::before {
				content: attr(data-text);
				position: absolute;
				z-index: -300;
				filter: url(#shadow);
			}
		}
	}

	svg {
		pointer-events: none;
		position: fixed;
	}
</style>
